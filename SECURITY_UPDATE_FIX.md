# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ü–ª–∞–≤–Ω–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏–π –∫–∏—è

## ‚ùì –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–≤–∏–∂–µ–Ω–∏—è –∫–∏—è —Å—Ç–∞–ª–∏ –ø—Ä–µ—Ä—ã–≤–∏—Å—Ç—ã–º–∏. –†–∞–Ω—å—à–µ –æ–±–∞ –∏–≥—Ä–æ–∫–∞ –≤–∏–¥–µ–ª–∏ –ø–ª–∞–≤–Ω—ã–µ –¥–≤–∏–∂–µ–Ω–∏—è –∫–∏—è –¥—Ä—É–≥ –¥—Ä—É–≥–∞, –∞ —Ç–µ–ø–µ—Ä—å —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–ª–æ —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏.

## üîç –ü—Ä–∏—á–∏–Ω–∞

–Ø –¥–æ–±–∞–≤–∏–ª –≤–∞–ª–∏–¥–∞—Ü–∏—é **–∫–æ –≤—Å–µ–º** —Å–æ–±—ã—Ç–∏—è–º, –≤–∫–ª—é—á–∞—è –≤–∏–∑—É–∞–ª—å–Ω—ã–µ (–¥–≤–∏–∂–µ–Ω–∏—è –∫–∏—è):
- `_onPressHitArea` - –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ –æ–±–ª–∞—Å—Ç—å —É–¥–∞—Ä–∞
- `_onPressMoveHitArea` - –¥–≤–∏–∂–µ–Ω–∏–µ –º—ã—à–∏ –ø—Ä–∏ –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏–∏
- `_onReleaseHitArea` - –æ—Ç–ø—É—Å–∫–∞–Ω–∏–µ –º—ã—à–∏
- `updateStick` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –∫–∏—è

–≠—Ç–∏ —Å–æ–±—ã—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è **–æ—á–µ–Ω—å —á–∞—Å—Ç–æ** (–ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ –º—ã—à–∏), –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–º–µ–¥–ª—è–ª–∞ –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫—É.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –†–∞–∑–¥–µ–ª–∏–ª —Å–æ–±—ã—Ç–∏—è –Ω–∞ 2 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:

#### üé® –í–∏–∑—É–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (–ë–ï–ó –≤–∞–ª–∏–¥–∞—Ü–∏–∏):
- `_onPressHitArea`
- `_onPressMoveHitArea`
- `_onReleaseHitArea`
- `updateStick`
- `_onPressDownCueBall`

**–ü–æ—á–µ–º—É –±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏?**
- –≠—Ç–æ —Ç–æ–ª—å–∫–æ –≤–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –¥—Ä—É–≥–æ–≥–æ –∏–≥—Ä–æ–∫–∞
- –ù–ï –≤–ª–∏—è–µ—Ç –Ω–∞ —Ñ–∏–∑–∏–∫—É –∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–≥—Ä—ã
- –û—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –æ—á–µ–Ω—å —á–∞—Å—Ç–æ (100+ —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É)
- –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–æ—Ä—Ç–∏—Ç –∏–≥—Ä–æ–≤–æ–π –æ–ø—ã—Ç

#### üîí –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è (–° –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π):
- `player-shot` - **–ö–†–ò–¢–ò–ß–ù–û!** –í–ª–∏—è–µ—Ç –Ω–∞ —Ñ–∏–∑–∏–∫—É
- `_onPressMoveCueBall` - **–ö–†–ò–¢–ò–ß–ù–û!** –ü–æ–∑–∏—Ü–∏—è –±–∏—Ç–∫–∞
- `send-message` - –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞

**–ü–æ—á–µ–º—É —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π?**
- –í–ª–∏—è—é—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–≥—Ä—ã
- –ú–æ–≥—É—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –¥–ª—è —á–∏—Ç–µ—Ä—Å—Ç–≤–∞
- –û—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ä–µ–¥–∫–æ (1-2 —Ä–∞–∑–∞ –∑–∞ —Ö–æ–¥)

---

### 2. –£–≤–µ–ª–∏—á–∏–ª –ª–∏–º–∏—Ç rate limiting –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π:

**–ë—ã–ª–æ:**
```javascript
const limit = 100; // 100 —Å–æ–±—ã—Ç–∏–π
const window = 60000; // –∑–∞ 60 —Å–µ–∫—É–Ω–¥
```

**–°—Ç–∞–ª–æ:**
```javascript
// –í–∏–∑—É–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (–¥–≤–∏–∂–µ–Ω–∏—è –∫–∏—è)
limit = 1000; // 1000 —Å–æ–±—ã—Ç–∏–π
window = 10000; // –∑–∞ 10 —Å–µ–∫—É–Ω–¥

// –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è
limit = 50; // 50 —Å–æ–±—ã—Ç–∏–π
window = 60000; // –∑–∞ 60 —Å–µ–∫—É–Ω–¥
```

---

### 3. –ò—Å–ø—Ä–∞–≤–∏–ª –≥—Ä–∞–Ω–∏—Ü—ã —Å—Ç–æ–ª–∞:

**–ë—ã–ª–æ:**
```javascript
const TABLE_BOUNDS = {
  minX: FIELD_POINTS[0].x + BALL_RADIUS * 2,
  maxX: FIELD_POINTS[1].x - BALL_RADIUS * 2,
  minY: FIELD_POINTS[0].y + BALL_RADIUS * 2,
  maxY: FIELD_POINTS[2].y - BALL_RADIUS * 2
};
```
–≠—Ç–æ –¥–∞–≤–∞–ª–æ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫—É—é –æ–±–ª–∞—Å—Ç—å (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã).

**–°—Ç–∞–ª–æ:**
```javascript
const TABLE_BOUNDS = {
  minX: 100,
  maxX: 1180,
  minY: 50,
  maxY: 650
};
```
–¢–µ–ø–µ—Ä—å –±–∏—Ç–æ–∫ –º–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ —Å—Ç–æ–ª–∞.

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç

| –ê—Å–ø–µ–∫—Ç | –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è | –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è |
|--------|----------------|-------------------|
| **–ü–ª–∞–≤–Ω–æ—Å—Ç—å –∫–∏—è** | ‚ùå –ü—Ä–µ—Ä—ã–≤–∏—Å—Ç–æ | ‚úÖ –ü–ª–∞–≤–Ω–æ |
| **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —É–¥–∞—Ä–∞** | ‚úÖ –ó–∞—â–∏—â–µ–Ω–æ | ‚úÖ –ó–∞—â–∏—â–µ–Ω–æ |
| **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –±–∏—Ç–∫–∞** | ‚úÖ –ó–∞—â–∏—â–µ–Ω–æ | ‚úÖ –ó–∞—â–∏—â–µ–Ω–æ |
| **Rate limiting** | ‚ö†Ô∏è –°–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–æ | ‚úÖ –£–º–Ω—ã–π |
| **–ò–≥—Ä–æ–≤–æ–π –æ–ø—ã—Ç** | ‚ùå –ü–ª–æ—Ö–æ–π | ‚úÖ –•–æ—Ä–æ—à–∏–π |

---

## üéØ –§–∏–ª–æ—Å–æ—Ñ–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### ‚úÖ –ß—Ç–æ –ù–£–ñ–ù–û –∑–∞—â–∏—â–∞—Ç—å:
1. **–§–∏–∑–∏–∫–∞ –∏–≥—Ä—ã** - —Å–∏–ª–∞ —É–¥–∞—Ä–∞, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
2. **–ü–æ–∑–∏—Ü–∏—è –±–∏—Ç–∫–∞** - –≥–¥–µ –∏–≥—Ä–æ–∫ —Å—Ç–∞–≤–∏—Ç –±–∏—Ç–æ–∫
3. **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã** - —Å—á–µ—Ç, –ø–æ–±–µ–¥–∞/–ø–æ—Ä–∞–∂–µ–Ω–∏–µ
4. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** - –∫—Ç–æ –µ—Å—Ç—å –∫—Ç–æ

### ‚ùå –ß—Ç–æ –ù–ï –ù–£–ñ–ù–û –∑–∞—â–∏—â–∞—Ç—å:
1. **–í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è** - –¥–≤–∏–∂–µ–Ω–∏—è –∫–∏—è, –∞–Ω–∏–º–∞—Ü–∏–∏
2. **–ü–æ–∑–∏—Ü–∏—è –∫—É—Ä—Å–æ—Ä–∞** - –≥–¥–µ –∏–≥—Ä–æ–∫ —Ü–µ–ª–∏—Ç—Å—è
3. **–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è** - –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏—è

**–ü—Ä–∞–≤–∏–ª–æ**: –ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –ù–ï –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–≥—Ä—ã - –Ω–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –≤–∞–ª–∏–¥–∞—Ü–∏—é!

---

## üîß –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –§–∞–π–ª: `controllers/Game.js`

**–£–±—Ä–∞–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è:**
```javascript
socket.on("_onPressHitArea", (e) => {
  if (socket.playerId !== _currentPlayer) return;
  // –ë–ï–ó –≤–∞–ª–∏–¥–∞—Ü–∏–∏ - —Ç–æ–ª—å–∫–æ –≤–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
  e.socket = true;
  this.send("_onPressHitArea", e);
});

socket.on("_onPressMoveHitArea", (e) => {
  if (socket.playerId !== _currentPlayer) return;
  // –ë–ï–ó –≤–∞–ª–∏–¥–∞—Ü–∏–∏ - –ø–ª–∞–≤–Ω—ã–µ –¥–≤–∏–∂–µ–Ω–∏—è –∫–∏—è
  this.send("_onPressMoveHitArea", e);
});

socket.on("_onReleaseHitArea", (e) => {
  if (socket.playerId !== _currentPlayer) return;
  // –ë–ï–ó –≤–∞–ª–∏–¥–∞—Ü–∏–∏
  this.send("_onReleaseHitArea", e);
});

socket.on("updateStick", (e) => {
  if (socket.playerId !== _currentPlayer) return;
  // –ë–ï–ó –≤–∞–ª–∏–¥–∞—Ü–∏–∏
  this.send("updateStick", e);
});
```

**–û—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è:**
```javascript
socket.on("player-shot", (e) => {
  if (socket.playerId !== _currentPlayer) return;
  // –° –í–ê–õ–ò–î–ê–¶–ò–ï–ô - –∫—Ä–∏—Ç–∏—á–Ω–æ!
  if (!this._validateEventData(e, 'shot')) {
    console.log("‚ö†Ô∏è Invalid player-shot data");
    socket.emit("error", { message: "Invalid shot data" });
    return;
  }
  _table.shotBall(e);
});

socket.on("_onPressMoveCueBall", (e) => {
  if (socket.playerId !== _currentPlayer) return;
  // –° –í–ê–õ–ò–î–ê–¶–ò–ï–ô - –ø–æ–∑–∏—Ü–∏—è –±–∏—Ç–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞!
  if (!this._validateEventData(e, 'position')) {
    console.log("‚ö†Ô∏è Invalid _onPressMoveCueBall data");
    return;
  }
  _table._onPressMoveCueBall(e);
  this.send("_onPressMoveCueBall", e);
});
```

---

### –§–∞–π–ª: `controllers/gameSocket.js`

**–£–º–Ω—ã–π rate limiting:**
```javascript
const checkSocketRateLimit = (socket, event) => {
  const key = `${socket.id}:${event}`;
  const now = Date.now();
  
  let limit, window;
  
  // –í–∏–∑—É–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è - –≤—ã—Å–æ–∫–∏–π –ª–∏–º–∏—Ç
  const visualEvents = ['_onPressHitArea', '_onPressMoveHitArea', '_onReleaseHitArea', 'updateStick'];
  if (visualEvents.includes(event)) {
    limit = 1000; // 1000 —Å–æ–±—ã—Ç–∏–π
    window = 10000; // –∑–∞ 10 —Å–µ–∫—É–Ω–¥
  } else {
    // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è - –Ω–∏–∑–∫–∏–π –ª–∏–º–∏—Ç
    limit = 50;
    window = 60000;
  }
  
  // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
};
```

---

### –§–∞–π–ª: `controllers/Table.js`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≥—Ä–∞–Ω–∏—Ü—ã —Å—Ç–æ–ª–∞:**
```javascript
this._isValidCueBallPosition = function(oPos) {
  if (!oPos || typeof oPos.x !== 'number' || typeof oPos.y !== 'number') {
    return false;
  }
  
  if (!isFinite(oPos.x) || !isFinite(oPos.y)) {
    return false;
  }
  
  // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã —Å—Ç–æ–ª–∞
  const TABLE_BOUNDS = {
    minX: 100,
    maxX: 1180,
    minY: 50,
    maxY: 650
  };
  
  if (oPos.x < TABLE_BOUNDS.minX || oPos.x > TABLE_BOUNDS.maxX ||
      oPos.y < TABLE_BOUNDS.minY || oPos.y > TABLE_BOUNDS.maxY) {
    console.log(`‚ö†Ô∏è Cue ball out of bounds: x=${oPos.x}, y=${oPos.y}`);
    return false;
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –¥—Ä—É–≥–∏–µ —à–∞—Ä—ã
  for (let i = 0; i < _aBalls.length; i++) {
    const ball = _aBalls[i];
    if (ball.getNumber() !== 0 && ball.isBallOnTable()) {
      const dx = oPos.x - ball.getX();
      const dy = oPos.y - ball.getY();
      const dist = Math.sqrt(dx * dx + dy * dy);
      
      if (dist < BALL_DIAMETER) {
        console.log(`‚ö†Ô∏è Cue ball overlaps with ball ${ball.getNumber()}`);
        return false;
      }
    }
  }
  
  return true;
};
```

---

## ‚úÖ –ò—Ç–æ–≥

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- ‚úÖ –°–∏–ª–∞ —É–¥–∞—Ä–∞ –∑–∞—â–∏—â–µ–Ω–∞ (max 40)
- ‚úÖ –ü–æ–∑–∏—Ü–∏—è –±–∏—Ç–∫–∞ –∑–∞—â–∏—â–µ–Ω–∞ (–≥—Ä–∞–Ω–∏—Ü—ã —Å—Ç–æ–ª–∞ + –Ω–∞–ª–æ–∂–µ–Ω–∏–µ)
- ‚úÖ Rate limiting —Ä–∞–±–æ—Ç–∞–µ—Ç —É–º–Ω–æ
- ‚úÖ CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –°–µ—Å—Å–∏–∏ –∑–∞—â–∏—â–µ–Ω—ã

**–ò–≥—Ä–æ–≤–æ–π –æ–ø—ã—Ç:**
- ‚úÖ –î–≤–∏–∂–µ–Ω–∏—è –∫–∏—è –ø–ª–∞–≤–Ω—ã–µ
- ‚úÖ –ü—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- ‚úÖ –û–±–∞ –∏–≥—Ä–æ–∫–∞ –≤–∏–¥—è—Ç –¥–µ–π—Å—Ç–≤–∏—è –¥—Ä—É–≥ –¥—Ä—É–≥–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –ù–µ—Ç –∑–∞–¥–µ—Ä–∂–µ–∫ –∏ –ª–∞–≥–æ–≤

**–ë–∞–ª–∞–Ω—Å –Ω–∞–π–¥–µ–Ω!** üéØ

–¢–µ–ø–µ—Ä—å –∏–≥—Ä–∞ –±–µ–∑–æ–ø–∞—Å–Ω–∞ –ò –ø—Ä–∏—è—Ç–Ω–∞ –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏! üéÆüõ°Ô∏è

